<!DOCTYPE html>
<html>
<head>
    <title>T2T2 QR Authentication</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
            text-align: center;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0088cc;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        #qr-container {
            margin: 30px 0;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #qr-code {
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 20px;
            background: white;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            font-weight: 500;
        }
        .status.waiting {
            background: #e3f2fd;
            color: #1976d2;
        }
        .status.success {
            background: #e8f5e9;
            color: #388e3c;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        .instructions {
            text-align: left;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .instructions h3 {
            margin-top: 0;
            color: #333;
        }
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .instructions li {
            margin: 5px 0;
        }
        .countdown {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0088cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .manual-auth {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }
        .manual-auth h3 {
            color: #666;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .manual-auth a {
            color: #0088cc;
            text-decoration: none;
        }
        .manual-auth a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>T2T2 Authentication</h1>
        <p class="subtitle">Secure login with QR code</p>
        
        <div class="instructions">
            <h3>How to authenticate:</h3>
            <ol>
                <li>Open Telegram on your phone</li>
                <li>Go to Settings â†’ Devices â†’ Scan QR Code</li>
                <li>Point your camera at the QR code below</li>
                <li>Confirm the login on your phone</li>
            </ol>
        </div>
        
        <div id="qr-container">
            <div class="spinner"></div>
        </div>
        
        <div id="status" class="status waiting">
            Connecting to authentication server...
        </div>
        
        <div id="countdown" class="countdown"></div>
        
        <div class="manual-auth">
            <h3>Having trouble?</h3>
            <p>You can also <a href="#" onclick="showManualAuth(); return false;">authenticate manually</a></p>
        </div>
    </div>
    
    <script>
        // Get parameters from URL
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session');
        const userId = params.get('user_id');
        const serverUrl = params.get('server') || 'http://localhost:5000';
        
        let countdownInterval;
        let checkInterval;
        
        if (!sessionId || !userId) {
            showError('Invalid session link. Please get a new link from the bot.');
        } else {
            // Try to connect to the QR server
            checkServerConnection();
        }
        
        async function checkServerConnection() {
            try {
                // First check if server is running
                const response = await fetch(`${serverUrl}/health`, { mode: 'cors' });
                if (response.ok) {
                    // Server is running, proceed with QR
                    checkForQR();
                } else {
                    showOfflineMessage();
                }
            } catch (e) {
                // Server is not accessible
                showOfflineMessage();
            }
        }
        
        function showOfflineMessage() {
            document.getElementById('status').className = 'status error';
            document.getElementById('status').innerHTML = `
                <strong>Authentication server is offline</strong><br><br>
                The admin needs to start the authentication server.<br>
                Please try again later or use manual authentication.
            `;
            document.getElementById('qr-container').innerHTML = '';
        }
        
        function showError(message) {
            document.getElementById('status').className = 'status error';
            document.getElementById('status').textContent = message;
            document.getElementById('qr-container').innerHTML = '';
        }
        
        async function checkForQR() {
            try {
                const response = await fetch(`${serverUrl}/qr/${sessionId}?user_id=${userId}`, { mode: 'cors' });
                const data = await response.json();
                
                if (data.qr_code) {
                    // Display QR code
                    document.getElementById('qr-container').innerHTML = 
                        `<img id="qr-code" src="${data.qr_code}" alt="QR Code" />`;
                    
                    document.getElementById('status').textContent = 
                        'Scan this QR code with Telegram on your phone';
                    
                    // Start countdown
                    startCountdown(data.expires_in || 30);
                    
                    // Start checking for authentication
                    checkInterval = setInterval(checkAuth, 2000);
                } else if (data.error) {
                    showError(data.error);
                } else {
                    // Keep checking
                    setTimeout(checkForQR, 1000);
                }
            } catch (e) {
                showError('Cannot connect to authentication server. Please try manual authentication.');
            }
        }
        
        async function checkAuth() {
            try {
                const response = await fetch(`${serverUrl}/check_auth/${sessionId}`, { mode: 'cors' });
                const data = await response.json();
                
                if (data.authenticated) {
                    clearInterval(checkInterval);
                    clearInterval(countdownInterval);
                    
                    document.getElementById('status').className = 'status success';
                    document.getElementById('status').innerHTML = 
                        'âœ… Authentication successful!<br><br>' +
                        'You can now close this window and return to Telegram.<br>' +
                        'Use /chats in the bot to select chats to index.';
                    
                    document.getElementById('qr-container').innerHTML = 
                        '<div style="font-size: 72px;">ðŸŽ‰</div>';
                    
                    document.getElementById('countdown').textContent = '';
                    document.querySelector('.manual-auth').style.display = 'none';
                } else if (data.expired) {
                    clearInterval(checkInterval);
                    clearInterval(countdownInterval);
                    
                    showError('QR code expired. Please get a new link from the bot.');
                }
            } catch (e) {
                // Continue checking
            }
        }
        
        function startCountdown(seconds) {
            let remaining = seconds;
            
            function update() {
                document.getElementById('countdown').textContent = 
                    `Code expires in ${remaining} seconds`;
                
                remaining--;
                if (remaining < 0) {
                    clearInterval(countdownInterval);
                    clearInterval(checkInterval);
                    showError('QR code expired. Please get a new link from the bot.');
                }
            }
            
            update();
            countdownInterval = setInterval(update, 1000);
        }
        
        function showManualAuth() {
            clearInterval(checkInterval);
            clearInterval(countdownInterval);
            
            document.getElementById('qr-container').innerHTML = '';
            document.getElementById('countdown').textContent = '';
            document.getElementById('status').className = 'status waiting';
            document.getElementById('status').innerHTML = `
                <strong>Manual Authentication</strong><br><br>
                Please contact the admin to complete your authentication.<br>
                Your User ID: <code>${userId}</code><br><br>
                The admin will help you authenticate without sharing passwords.
            `;
            document.querySelector('.manual-auth').style.display = 'none';
        }
    </script>
</body>
</html>